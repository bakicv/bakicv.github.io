<html>
<head>
<title></title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script>
	
var urlParams;
(window.onpopstate = function () {
    var match,
        pl     = /\+/g,  // Regex for replacing addition symbol with a space
        search = /([^&=]+)=?([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query)){
        key = decode(match[1]);
        val = decode(match[2]);
        if (key.indexOf('[]') != -1){
        	if (urlParams[key] ===  undefined ){
        		urlParams[key] = [val]	
        	}
        	else{
        		urlParams[key].push(val)
        	}
        }
        else{
        	urlParams[key] = val;	
        }
        
    	}
})();

current_video = 0;
videos = [];

$(document).ready(function(){

	// init url yarns
    if (urlParams['videos[]']){
    	for (i=0; i<urlParams['videos[]'].length; i++){
    		page = 'https://getyarn.io/yarn-clip/'+urlParams['videos[]'][i]
    		$('#yarns').append($('<li>', {text:page, 'data-id':urlParams['videos[]'][i]}))
    	}
    }

    var onEnd = function(){
    	console.log('ended')
    	videos[current_video].hide();
		current_video++;
		if (videos[current_video] !== undefined){
			videos[current_video].show()
			videos[current_video].get(0).play();
			}
		else{
			videos[0].show()
			current_video = 0
			}
    }

    var updateUrl = function(){
    	var ids = $.map($('#yarns li'), function(li){
    		console.log($(li).data('id'))
	    	return $(li).data('id');
	    	})

    	if (ids.length)
	    	$('#yarnlist').val('http://bakicv.github.io/yarnio.html?videos[]='+ids.join('&videos[]='))
    }

    var processVideos = function(){
			
			videos = [];

			var ids = $.map($('#yarns li'), function(li){
		    	return $(li).data('id')
		    	})

			$('#videos').empty()
	    	for (i=0; i<ids.length; i++){
	    		url = 'https://storage.googleapis.com/vidsums/'+ids[i]+'.mp4'
	    		//page = 'http://getyarn.io/yarn-clip/'+ids[i]
	    		//$('#yarns').append($('<li>', {text:page}))
	    		video = $('<video />', {'src':url, type:'video/mp4', controls:false})
	    		video_obj = video.get(0)
	    		videos.push(video)
	    		video_obj.load();
	    		video_obj.addEventListener('ended', onEnd, false);
				video.hide();
	    		$('#videos').append(video);
	    		//videos.push(url);
	    	}

	    	if (videos.length)
				videos[0].show();
	    }
	var init =function(){
	    var play = $('#unroll').click(function(){
	    	videos[0].get(0).play()
	    	})

		$('#yarns').sortable()

	    $('body').on('paste', function(e){
	    	e.preventDefault();
		    var text = (e.originalEvent || e).clipboardData.getData('text/plain') || '';
		    var options = $.map($('#yarns li'), function(li){
		    	return $(li).text()
		    	})
		    //if (options.indexOf(text) == -1)
		    if (text.indexOf('getyarn.io/yarn-clip') != -1){
		    	var id = text.substring(text.lastIndexOf('/')+1)
		    	$('#yarns').append($('<li>', {text:text, 'data-id':id}))
		    	}

			updateUrl()
			processVideos()
	    })

		updateUrl()
		processVideos()
		}

	init()
});

</script>

<style>
	
textarea {
    width: 800px;
    height: 150px;
	}

#yarns {
	padding:0;
	margin:0;
}
#yarns li{
	font-family: Arial;
	width:800;
	border:1px solid gray;
	list-style: none;
	padding:0;
	margin:0;
	margin-bottom:2px;
}
#yarnlist{
	width:800px;
	border:1px solid blue;
}
</style>
</head>
<body>

<input id="yarnlist" />
<br>
<br>

<div id="videos"></div>
<br>
<button id="unroll">Unroll the yarn!</button>
<br><br>

<ul id="yarns"></ul>
<br>

</body>
</html>